<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>heqiao2010</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="heqiao2010">
<meta property="og:url" content="http://heqiao2010.github.io/page/2/index.html">
<meta property="og:site_name" content="heqiao2010">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="heqiao2010">
<meta property="article:tag" content="java,go">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="heqiao2010" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">heqiao2010</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://heqiao2010.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-一次重写RequestMappingHandlerMapping的经历" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/17/%E4%B8%80%E6%AC%A1%E9%87%8D%E5%86%99RequestMappingHandlerMapping%E7%9A%84%E7%BB%8F%E5%8E%86/" class="article-date">
  <time datetime="2019-06-17T10:00:00.000Z" itemprop="datePublished">2019-06-17</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/17/%E4%B8%80%E6%AC%A1%E9%87%8D%E5%86%99RequestMappingHandlerMapping%E7%9A%84%E7%BB%8F%E5%8E%86/">记一次重写RequestMappingHandlerMapping的经历</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>近期公司的产品做了一次安全审查，发现后端提供的接口有<strong>不安全的Http方法</strong>漏洞。不安全的HTTP方法一般包括：TRACE、PUT、DELETE、COPY 等。其中最常见的为TRACE方法可以回显服务器收到的请求，主要用于测试或诊断，恶意攻击者可以利用该方法进行跨站跟踪攻击（即XST攻击），从而进行网站钓鱼、盗取管理员cookie等。</p>
</blockquote>
<h2 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h2><p>引起这个问题的原因其实很简单，因为开发人员开发接口的时候偷懒没有指定RequestMapping中的method属性导致的。没有指定method则系统会默认支持除了TRACE之外的其他７中方式，所以，这就是我要重写的RequestMappingHandlerMapping原因。</p>
<p>当然还有其他的方式，比如搜索出所有采用RequestMapping而没有指定method的地方，然后在代码中明确指定method。这种方式思路最简单，但是毕竟人是懒惰的。而且将来代码开发中如果任然有人不指定method，那么这个问题任然会存在。所以我们需要改动一下，框架加载http接口映射关系的逻辑：</p>
<p>在没有指定method的情况下，只支持GET和POST；在明确指定method的情况下，保留指定的method。</p>
<h2 id="为什么重写的是RequestMappingHandlerMapping"><a href="#为什么重写的是RequestMappingHandlerMapping" class="headerlink" title="为什么重写的是RequestMappingHandlerMapping"></a>为什么重写的是RequestMappingHandlerMapping</h2><p>首先后端提供的Http请求均是通过RestController和RequestMapping(或者衍生的GetMapping/PostMapping等)来实现的。那在接收http请求之后，如何将http请求映射到具体的Controller中的方法上呢？答案在HandlerMapping这个接口。这个具体映射过程细节以后再说，而HandlerMapping接口的映射方法getHandler是在AbstractHandlerMapping中实现的，而AbstractHandlerMapping的一个非抽象子类就是RequestMappingHandlerMapping。</p>
<h2 id="重写RequestMappingHandlerMapping的哪个方法"><a href="#重写RequestMappingHandlerMapping的哪个方法" class="headerlink" title="重写RequestMappingHandlerMapping的哪个方法"></a>重写RequestMappingHandlerMapping的哪个方法</h2><p>从RequestMappingHandlerMapping中的getMappingForMethod方法可以看出，接口的映射信息，是由两部分组成的。一部分是来自于Controller类上的RequestMapping注解，一部分是来自于方法上的RequestMapping注解。所以，在这个方法中createRequestMappingInfo调用了两次，然后再组合。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">@Override</span><br><span class="line">	protected RequestMappingInfo getMappingForMethod(Method method, Class&lt;?&gt; handlerType) &#123;</span><br><span class="line">		RequestMappingInfo info &#x3D; createRequestMappingInfo(method);</span><br><span class="line">		if (info !&#x3D; null) &#123;</span><br><span class="line">			RequestMappingInfo typeInfo &#x3D; createRequestMappingInfo(handlerType);</span><br><span class="line">			if (typeInfo !&#x3D; null) &#123;</span><br><span class="line">				info &#x3D; typeInfo.combine(info);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		return info;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>真正的createRequestMappingInfo有一个代理方法。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">private RequestMappingInfo createRequestMappingInfo(AnnotatedElement element) &#123;</span><br><span class="line">		RequestMapping requestMapping &#x3D; AnnotatedElementUtils.findMergedAnnotation(element, RequestMapping.class);</span><br><span class="line">		RequestCondition&lt;?&gt; condition &#x3D; (element instanceof Class ?</span><br><span class="line">				getCustomTypeCondition((Class&lt;?&gt;) element) : getCustomMethodCondition((Method) element));</span><br><span class="line">		return (requestMapping !&#x3D; null ? createRequestMappingInfo(requestMapping, condition) : null);</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>在createRequestMappingInfo中，找到我们想要改动的地方了。在RequestMappingInfo设置method的时候增加一段自己的逻辑即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">protected RequestMappingInfo createRequestMappingInfo(</span><br><span class="line">			RequestMapping requestMapping, RequestCondition&lt;?&gt; customCondition) &#123;</span><br><span class="line"></span><br><span class="line">		return RequestMappingInfo</span><br><span class="line">				.paths(resolveEmbeddedValuesInPatterns(requestMapping.path()))</span><br><span class="line">				.methods(requestMapping.method())</span><br><span class="line">				.params(requestMapping.params())</span><br><span class="line">				.headers(requestMapping.headers())</span><br><span class="line">				.consumes(requestMapping.consumes())</span><br><span class="line">				.produces(requestMapping.produces())</span><br><span class="line">				.mappingName(requestMapping.name())</span><br><span class="line">				.customCondition(customCondition)</span><br><span class="line">				.options(this.config)</span><br><span class="line">				.build();</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>

<p>至此,可以重写RequestMappingHandlerMapping如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">public class HttpSafetyRequestMappingHandlerMapping extends RequestMappingHandlerMapping&#123;</span><br><span class="line"></span><br><span class="line">    private RequestMappingInfo.BuilderConfiguration config &#x3D; new RequestMappingInfo.BuilderConfiguration();</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected RequestMappingInfo createRequestMappingInfo(RequestMapping requestMapping,</span><br><span class="line">                                                          RequestCondition&lt;?&gt; customCondition) &#123;</span><br><span class="line">        &#x2F;&#x2F; 如果Controller的方法上RequestMapping没有指定Method，则只支持GET和POST</span><br><span class="line">        RequestMethod[] methods &#x3D; &#123; RequestMethod.GET, RequestMethod.POST &#125;;</span><br><span class="line"></span><br><span class="line">        if(requestMapping.method().length !&#x3D; 0)&#123;</span><br><span class="line">            methods &#x3D; requestMapping.method();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return RequestMappingInfo</span><br><span class="line">                .paths(resolveEmbeddedValuesInPatterns(requestMapping.path()))</span><br><span class="line">                .methods(methods)</span><br><span class="line">                .params(requestMapping.params())</span><br><span class="line">                .headers(requestMapping.headers())</span><br><span class="line">                .consumes(requestMapping.consumes())</span><br><span class="line">                .produces(requestMapping.produces())</span><br><span class="line">                .mappingName(requestMapping.name())</span><br><span class="line">                .customCondition(customCondition)</span><br><span class="line">                .options(config)</span><br><span class="line">                .build();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    protected RequestMappingInfo getMappingForMethod(Method method, Class&lt;?&gt; handlerType) &#123;</span><br><span class="line">        RequestMappingInfo info &#x3D; createRequestMappingInfo(method);</span><br><span class="line">        if (info !&#x3D; null) &#123;</span><br><span class="line">            RequestMappingInfo typeInfo &#x3D; createRequestMappingInfo(handlerType);</span><br><span class="line">            if (typeInfo !&#x3D; null) &#123;</span><br><span class="line">                info &#x3D; typeInfo.combine(info);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        return info;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private RequestMappingInfo createRequestMappingInfo(AnnotatedElement element) &#123;</span><br><span class="line">        RequestMapping requestMapping &#x3D; AnnotatedElementUtils.findMergedAnnotation(element, RequestMapping.class);</span><br><span class="line">        RequestCondition&lt;?&gt; condition &#x3D; (element instanceof Class ?</span><br><span class="line">                getCustomTypeCondition((Class&lt;?&gt;) element) : getCustomMethodCondition((Method) element));</span><br><span class="line">        if(requestMapping &#x3D;&#x3D; null)&#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        &#x2F;&#x2F; 只需要处理方法上的RequestMapping，Controller类上的不需要处理</span><br><span class="line">        if(element instanceof Class)&#123;</span><br><span class="line">            return super.createRequestMappingInfo(requestMapping, condition);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return createRequestMappingInfo(requestMapping, condition);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void afterPropertiesSet() &#123;</span><br><span class="line">        this.config &#x3D; new RequestMappingInfo.BuilderConfiguration();</span><br><span class="line">        this.config.setUrlPathHelper(getUrlPathHelper());</span><br><span class="line">        this.config.setPathMatcher(getPathMatcher());</span><br><span class="line">        this.config.setSuffixPatternMatch(useSuffixPatternMatch());</span><br><span class="line">        this.config.setTrailingSlashMatch(useTrailingSlashMatch());</span><br><span class="line">        this.config.setRegisteredSuffixPatternMatch(useRegisteredSuffixPatternMatch());</span><br><span class="line">        this.config.setContentNegotiationManager(getContentNegotiationManager());</span><br><span class="line">        super.afterPropertiesSet();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="如何替换"><a href="#如何替换" class="headerlink" title="如何替换"></a>如何替换</h2><p>网关服务采用Spring boot开发，那么我们可以从<code>org.springframework.boot.autoconfigure.web.WebMvcAutoConfiguration</code>入手。此类中有一个内部类：EnableWebMvcConfiguration，它继承并重写了createRequestMappingHandlerMapping方法。我们知道，在WebMvcConfigurationSupport类中，RequestMappingHandlerMapping实例的获取是通过其：requestMappingHandlerMapping方法上增加Bean注解来实现的。</p>
<p>这几个类的关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">WebMvcConfigurationSupport</span><br><span class="line">^</span><br><span class="line">| 继承</span><br><span class="line">DelegatingWebMvcConfiguration</span><br><span class="line">^</span><br><span class="line">| 继承</span><br><span class="line">EnableWebMvcConfiguration</span><br><span class="line">^      ^ </span><br><span class="line">|      | @Import</span><br><span class="line">|　WebMvcAutoConfigurationAdapter</span><br><span class="line">|　　　　　　　 ^ 静态内部类</span><br><span class="line">|             |</span><br><span class="line">| 静态内部类　　|</span><br><span class="line">WebMvcAutoConfiguration</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在WebMvcConfigurationSupport的requestMappingHandlerMapping方法中，RequestMappingHanlderMapping是通过调用createRequestMappingHandlerMapping方法来实现的。所以要覆盖RequestMappingHanlderMapping的实现，只需要重写createRequestMappingHandlerMapping即可。而EnableWebMvcConfiguration已经将这个方法重写如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">      @Override</span><br><span class="line">protected RequestMappingHandlerMapping createRequestMappingHandlerMapping() &#123;</span><br><span class="line">	if (this.mvcRegistrations !&#x3D; null</span><br><span class="line">			&amp;&amp; this.mvcRegistrations.getRequestMappingHandlerMapping() !&#x3D; null) &#123;</span><br><span class="line">		return this.mvcRegistrations.getRequestMappingHandlerMapping();</span><br><span class="line">	&#125;</span><br><span class="line">	return super.createRequestMappingHandlerMapping();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从上面的代码可以看出，EnableWebMvcConfiguration已经提供了替换RequestMappingHandlerMapping的方式，那就是：WebMvcRegistrations。而WebMvcRegistrations是个接口，并有一个默认的空实现：WebMvcRegistrationsAdapter，只需要覆盖其中的getRequestMappingHandlerMapping方法即可。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">@Component</span><br><span class="line">public class SafetyWebMvcRegistrationsAdapter extends WebMvcRegistrationsAdapter&#123;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public RequestMappingHandlerMapping getRequestMappingHandlerMapping() &#123;</span><br><span class="line">        return new HttpSafetyRequestMappingHandlerMapping();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>至此Sping boot中替换RequestMappingHandlerMapping的实现就结束了。</p>
<p>不过我们另一个服务采用的是Spring mvc,上面的替换就不生效了。因为服务中WebApplicationContext是通过@EnableWebMvc注入的配置。而在这个注解中导入的实际上是DelegatingWebMvcConfiguration。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">@Retention(RetentionPolicy.RUNTIME)</span><br><span class="line">@Target(ElementType.TYPE)</span><br><span class="line">@Documented</span><br><span class="line">@Import(DelegatingWebMvcConfiguration.class)</span><br><span class="line">public @interface EnableWebMvc &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以把@EnableWebMvc替换成@Import(WebMvcAutoConfiguration.EnableWebMvcConfiguration.class)即可。或者重写DelegatingWebMvcConfiguration，覆盖createRequestMappingHandlerMapping方法也是可以的。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2019/06/17/%E4%B8%80%E6%AC%A1%E9%87%8D%E5%86%99RequestMappingHandlerMapping%E7%9A%84%E7%BB%8F%E5%8E%86/" data-id="ckgkgph5d001leyww1p3ac9cf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-如何获取用户真实IP" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/14/%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E7%9C%9F%E5%AE%9EIP/" class="article-date">
  <time datetime="2019-06-14T10:00:00.000Z" itemprop="datePublished">2019-06-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF/">服务端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/14/%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E7%9C%9F%E5%AE%9EIP/">如何获取用户真实IP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <blockquote>
<p>在web开发过程中，我们经常需要获取用户客户端的真实IP。比如我们想知道客户的地理位置分布；比如服务端需要将会话和IP地址绑定，以提高安全性等。但是一般在分布式系统中，为了提高系统的可靠性和性能，都会采用代理来分发用户的请求，导致获取用户真实IP变得有些麻烦。</p>
</blockquote>
<h2 id="获取调用方IP的方法"><a href="#获取调用方IP的方法" class="headerlink" title="获取调用方IP的方法"></a>获取调用方IP的方法</h2><p>直接调用HttpServletRequest中的request.getRemoteAddr()方法，获取的IP地址，是当前服务的上游服务的IP地址，在没有代理的情况下是准确的，不过一般都会有一个或者多个代理，这种方式一般不适用。一般可能用如下几个字段</p>
<h3 id="X-FORWARDED-FOR"><a href="#X-FORWARDED-FOR" class="headerlink" title="X-FORWARDED-FOR"></a>X-FORWARDED-FOR</h3><p>X-FORWARDED-FOR这个http头是个调试参数，在代理服务器上做相关的配置，能够实现，在经过每一个代理的时候，会往后追加上代理的IP地址；这样通过这个字段就可以知道，这个请求被代理了多少次，每次代理是由那个IP处理的；所以取列表第一个IP就是用户的真实IP地址了。</p>
<p>nginx支持X-FORWARDED-FOR的配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br></pre></td></tr></table></figure>

<h3 id="Proxy-Client-IP"><a href="#Proxy-Client-IP" class="headerlink" title="Proxy-Client-IP"></a>Proxy-Client-IP</h3><p>用apache http做代理时一般会加上Proxy-Client-IP请求头</p>
<h3 id="WL-Proxy-Client-IP"><a href="#WL-Proxy-Client-IP" class="headerlink" title="WL-Proxy-Client-IP"></a>WL-Proxy-Client-IP</h3><p>weblogic插件加上的头</p>
<h3 id="HTTP-CLIENT-IP"><a href="#HTTP-CLIENT-IP" class="headerlink" title="HTTP_CLIENT_IP"></a>HTTP_CLIENT_IP</h3><p>有些代理服务器会加上此请求头。</p>
<h3 id="X-Real-IP"><a href="#X-Real-IP" class="headerlink" title="X-Real-IP"></a>X-Real-IP</h3><p>在nginx中可以把上游调用的真实IP加到HTTP请求头中，这个IP从remote_addr变量中获取是从TCP链接中获取的真实IP。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxy_set_header X-Real-IP $remote_addr;</span><br></pre></td></tr></table></figure>

<h2 id="某些特殊情况"><a href="#某些特殊情况" class="headerlink" title="某些特殊情况"></a>某些特殊情况</h2><p>正常我们会按照上面的顺序按照优先级获取真实的IP地址。网上一般都会把X-FORWARDED-FOR这个参数作为第一优先级来处理。但是这个参数实际上是不安全的。<br>X-FORWARDED-FOR这个参数的值是个列表，每次经过代理都是往后追加，而不是覆盖的。所以不能确保IP是可信的。客户端可以先伪造一个IP放到头部，真实IP就会在伪造IP之后了。比如：</p>
<p>客户端伪造</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-FORWARDED-FOR：　1.1.1.1</span><br></pre></td></tr></table></figure>
<p>经过两次代理（192.168.1.2,192.168.1.3）之后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">X-FORWARDED-FOR：　1.1.1.1,108.10.10.123,192.168.1.2,192.168.1.3</span><br></pre></td></tr></table></figure>
<p>这样获取到的IP地址是1.1.1.1，而不是真正的108.10.10.123。其实真实IP已经在列表中了，怎么避免获取伪造的IP？</p>
<p>nginx有个realip模块，可以通过set_real_ip_from命令制定代理服务器的IP,因为代理服务器的IP地址都是已知的，所以可以通过从右至左依次获取第一个不在代理IP列表中的合法IP就是用户真实IP地址了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">set_real_ip_from  192.168.1.2;</span><br><span class="line">set_real_ip_from  192.168.1.3;</span><br><span class="line">real_ip_header    X-Forwarded-For;</span><br><span class="line">real_ip_recursive on;</span><br></pre></td></tr></table></figure>
<p>安装realip模块需要重新编译nginx，比较麻烦，也可以直接通过最上层代理（第一层代理）服务器获取用户真实IP，写入http头部，后端服务优先获取此参数即可。比如：第一层代理是nginx,将remote_addr参数写入X-Real-IP，后端优先获取此参数，其他代理不要覆盖此参数即可；由于参数是覆盖写入的，就算客户端伪造一个X-Real-IP参数头，也会被代理服务器复写为真实的IP.</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/1e0124de8e02">https://www.jianshu.com/p/1e0124de8e02</a><br><a target="_blank" rel="noopener" href="http://nginx.org/en/docs/http/ngx_http_realip_module.html">http://nginx.org/en/docs/http/ngx_http_realip_module.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2019/06/14/%E5%A6%82%E4%BD%95%E8%8E%B7%E5%8F%96%E7%94%A8%E6%88%B7%E7%9C%9F%E5%AE%9EIP/" data-id="ckgkgph5l0028eyww1wwa0uk2" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E7%AB%AF/" rel="tag">服务端</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-git技巧之gitstash" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/13/git%E6%8A%80%E5%B7%A7%E4%B9%8Bgitstash/" class="article-date">
  <time datetime="2019-06-13T10:00:00.000Z" itemprop="datePublished">2019-06-13</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/git/">git</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/13/git%E6%8A%80%E5%B7%A7%E4%B9%8Bgitstash/">git技巧之git stash</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="功能"><a href="#功能" class="headerlink" title="功能"></a>功能</h2><p>英文单词：stash的原意是储藏的意思。当我们在开发过程中，代码写了一部分，由于某种原因需要切换到另一个分支上，比如临时需要切换到另一个需求上开发另一个任务，这个时候就我们就需要某种手段临时保存手头上没有完成的任务，在另一个任务做完了之后，再恢复这个没有完成的任务继续开发。这个过程是不是有点类似，操作系统中发生函数调用时，保存现场和恢复现场？</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><ol>
<li><p>创建存储</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash</span><br></pre></td></tr></table></figure>
<p>运行这个命令之后，会将当前所有的修改存储起来，再次运行git statu,会发现目录恢复成clean的状态了。这个时候就可以切换到其他分支了。</p>
</li>
<li><p>查看存储列表</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash list</span><br></pre></td></tr></table></figure>
<p>有时候，我们运行了stash多次，通过上面的命令，可以查看每次存储的记录；类似：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ git stash list</span><br><span class="line">stash@&#123;0&#125;: WIP on master: 049d078 added the index file</span><br><span class="line">stash@&#123;1&#125;: WIP on master: c264051 Revert &quot;added file_size&quot;</span><br><span class="line">stash@&#123;2&#125;: WIP on master: 21d80a5 added number to log</span><br></pre></td></tr></table></figure>
</li>
<li><p>恢复存储</p>
</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git stash apply #应用存储</span><br><span class="line">git stash pop　 #应用并删除存储</span><br><span class="line">git stash drop　＃删除存储</span><br></pre></td></tr></table></figure>

<p>上面的命令默认对最近一次的存储进行操作，如果需要制定那个存储，可以在明后跟上存储的名称，例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash apply stash@&#123;2&#125;</span><br></pre></td></tr></table></figure>

<p>##从储藏中创建分支</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash branch [分支名]</span><br></pre></td></tr></table></figure>
<p>有时候想要对于暂存的代码新创建一个分支，可以用上面的命令进行；一般这种情况可能是应用存储时发生冲突，或者是想要创建分支进行其他操作。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a target="_blank" rel="noopener" href="https://git-scm.com/book/zh/v1/Git-%E5%B7%A5%E5%85%B7-%E5%82%A8%E8%97%8F%EF%BC%88Stashing%EF%BC%89">https://git-scm.com/book/zh/v1/Git-%E5%B7%A5%E5%85%B7-%E5%82%A8%E8%97%8F%EF%BC%88Stashing%EF%BC%89</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2019/06/13/git%E6%8A%80%E5%B7%A7%E4%B9%8Bgitstash/" data-id="ckgkgph5a001eeywwacco01oh" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/git/" rel="tag">git</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Syslog基础" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/10/Syslog%E5%9F%BA%E7%A1%80/" class="article-date">
  <time datetime="2019-06-10T10:00:00.000Z" itemprop="datePublished">2019-06-10</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/syslog/">syslog</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/10/Syslog%E5%9F%BA%E7%A1%80/">Syslog基础</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Syslog基础"><a href="#Syslog基础" class="headerlink" title="Syslog基础"></a>Syslog基础</h1><p>Syslog是类Unix操作系统中，用于记录系统日志（产生自本地或者远程操作系统）到本地磁盘的一套日志格式以及对应的程序。完整的syslog日志中包含产生日志的程序模块（Facility）、严重性（Severity或 Level）、时间、主机名或IP、进程名、进程ID和正文。</p>
<h1 id="Syslog日志格式"><a href="#Syslog日志格式" class="headerlink" title="Syslog日志格式"></a>Syslog日志格式</h1><p>Syslog日志格式比较松散，一般分为PRI，HEADER以及MSG三个部分，例如：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;30&gt;Oct 9 22:33:20 hlfedora auditd[1787]: The audit daemon is exiting.</span><br></pre></td></tr></table></figure>

<h2 id="PRI部分"><a href="#PRI部分" class="headerlink" title="PRI部分"></a>PRI部分</h2><p>PRI部分由尖括号包含的一个数字构成，这个数字包含了程序模块（Facility）、严重性（Severity），这个数字是由Facility乘以 8，然后加上Severity得来。也就是说这个数字如果换成2进制的话，低位的3个bit表示Severity，剩下的高位的部分右移3位，就是表示Facility的值。Facility的定义如下：</p>
<p>|Numerical Code |         Facility|<br>-|-|-<br>|           0   |         kernel messages|<br>|           1   |         user-level messages|<br>|           2   |         mail system|<br>|           3   |         system daemons|<br>|           4   |         security/authorization messages (note 1)|<br>|           5   |         messages generated internally by syslogd|<br>|           6   |         line printer subsystem|<br>|           7   |         network news subsystem|<br>|           8   |         UUCP subsystem|<br>|           9   |         clock daemon (note 2)|<br>|          10   |         security/authorization messages (note 1)|<br>|          11   |         FTP daemon|<br>|          12   |         NTP subsystem|<br>|          13   |         log audit (note 1)|<br>|          14   |         log alert (note 1)|<br>|          15   |         clock daemon (note 2)|<br>|          16   |         local use 0  (local0)|<br>|          17   |         local use 1  (local1)|<br>|          18   |         local use 2  (local2)|<br>|          19   |         local use 3  (local3)|<br>|          20   |         local use 4  (local4)|<br>|          21   |         local use 5  (local5)|<br>|          22   |         local use 6  (local6)|<br>|          23   |         local use 7  (local7)|</p>
<p>Severity的定义：</p>
<p>|Numerical  Code |      Severity|<br>-|-|-<br>|           0    |   Emergency: system is unusable|<br>|           1    |   Alert: action must be taken immediately|<br>|           2    |   Critical: critical conditions|<br>|           3    |   Error: error conditions|<br>|           4    |   Warning: warning conditions|<br>|           5    |   Notice: normal but significant condition|<br>|           6    |   Informational: informational messages|<br>|           7    |   Debug: debug-level messages|</p>
<h2 id="HEADER部分"><a href="#HEADER部分" class="headerlink" title="HEADER部分"></a>HEADER部分</h2><p>HEADER部分包括两个字段，时间和主机名（或IP）。<br>时间紧跟在PRI后面，中间没有空格，格式必须是“Mmm dd hh:mm:ss”，不包括年份。“日”的数字如果是1～9，前面会补一个空格（也就是月份后面有两个空格），而“小时”、“分”、“秒”则在前面补“0”。月份取值包括：Jan, Feb, Mar, Apr, May, Jun, Jul, Aug, Sep, Oct, Nov, Dec；时间后边跟一个空格，然后是主机名或者IP地址，主机名不得包括域名部分。</p>
<h2 id="MSG部分"><a href="#MSG部分" class="headerlink" title="MSG部分"></a>MSG部分</h2><p>MSG部分又分为两个部分，TAG和Content。其中TAG部分是可选的。在前面的例子中（“&lt;30&gt;Oct 9 22:33:20 hlfedora auditd[1787]: The audit daemon is exiting.”），“auditd[1787]”是TAG部分，包含了进程名称和进程PID。PID可以没有，这个时候中括号也是没有的。进程PID有时甚至不是一个数字，例如“root-1787”，解析程序要做好容错准备。TAG后面用一个冒号隔开Content部分，这部分的内容是应用程序自定义的。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/skyofbitbit/p/3674664.html">https://www.cnblogs.com/skyofbitbit/p/3674664.html</a></p>
<p><a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc3164.txt">http://www.ietf.org/rfc/rfc3164.txt</a></p>
<p><a target="_blank" rel="noopener" href="http://www.ietf.org/rfc/rfc3195.txt">http://www.ietf.org/rfc/rfc3195.txt</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2019/06/10/Syslog%E5%9F%BA%E7%A1%80/" data-id="ckgkgph55000weywwbpixa2oj" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/linux/" rel="tag">linux</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-Swagger" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/06/06/Swagger/" class="article-date">
  <time datetime="2019-06-06T10:00:00.000Z" itemprop="datePublished">2019-06-06</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Swagger/">Swagger</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/06/06/Swagger/">Swagger</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Swagger使用说明"><a href="#Swagger使用说明" class="headerlink" title="Swagger使用说明"></a>Swagger使用说明</h2><h3 id="功能简介"><a href="#功能简介" class="headerlink" title="功能简介"></a>功能简介</h3><p>Swagger是一套治理API的工具，根据OAS（Open Api Specification）这个描述API的规则，实现API盘点、测试以及归档等功能。目前在wisteria功能中，可以在嵌入很少的侵入代码的情况下实现API的盘点功能——我们可以获取到一个最新的，随时和代码保持同步的API文档。</p>
<h3 id="使用步骤"><a href="#使用步骤" class="headerlink" title="使用步骤"></a>使用步骤</h3><ol>
<li><p>引入工程依赖</p>
<p> compile “io.springfox:springfox-swagger2:2.9.2”</p>
</li>
<li><p>添加API文档支持</p>
</li>
</ol>
<p>在项目中，采用开开源的springfox支持API信息的采集。 </p>
<p>(1)非Spring MVC项目(可以跳过该步骤)</p>
<p>(2)Spring MVC项目</p>
<p>需要在MvcConfig中增加<code>@EnableSwagger2</code>注解，同时注入Bean<code>Docket</code>即可。</p>
<pre><code>@Configuration
@EnableSwagger2
@ComponentScan(basePackages = &quot;com.xxx.frontend&quot;,
    nameGenerator = FullBeanNameGenerator.class)
@EnableWebMvc
@EnableAspectJAutoProxy(proxyTargetClass = true)
public class MvcConfig extends WebMvcConfigurerAdapter&#123;
    @Bean
    public Docket apiDocket() &#123;
        return new Docket(DocumentationType.SWAGGER_2)
                .enable(swaggerStatus)
                .apiInfo(createDefaultApiInfo())
                .groupName(appName + &quot;frontend&quot;)
                .select()
                .apis(RequestHandlerSelectors.basePackage(&quot;com.xxx&quot;))
                .paths(PathSelectors.any())
                .build();
    &#125;
    private ApiInfo createDefaultApiInfo()&#123;
        return new ApiInfoBuilder()
                .title(appName)
                .description(appName + &quot; frontend api 文档&quot;)
                .termsOfServiceUrl(&quot;http://www.xxx.cn&quot;)
                .build();
    &#125;
&#125;</code></pre>
<p>(3)添加API描述</p>
<p>Springfox定义了一系列的注解，用于更好的描述各个API的内容，包括输入输出以及字段类型和限制等。如果不添加这些内容，API的信息也是可以获取到的，只是不是很全面而已。</p>
<p>描述Controller的注解：</p>
<p>  @Api describes the whole controller<br>  @ApiOperation is used for description on a methods level<br>  @ApiParam is used for method parameters</p>
<p>示例：</p>
<pre><code>@RestController
@RequestMapping(&quot;/v2/persons/&quot;)
@Api(description = &quot;Set of endpoints for Creating, Retrieving, Updating and Deleting of Persons.&quot;)
public class PersonController &#123;
    private PersonService personService;
    @RequestMapping(method = RequestMethod.GET, path = &quot;/&#123;id&#125;&quot;, produces = &quot;application/json&quot;)
    @ApiOperation(&quot;Returns a specific person by their identifier. 404 if does not exist.&quot;)
    public Person getPersonById(@ApiParam(&quot;Id of the person to be obtained. Cannot be empty.&quot;)
                                    @PathVariable int id) &#123;
        return personService.getPersonById(id);
    &#125;
&#125;</code></pre>
<p>描述Model的注解：</p>
<p>示例：</p>
<pre><code>&#123;
    @ApiModel(description = &quot;Class representing a person tracked by the application.&quot;)
    public class Person &#123;
    @ApiModelProperty(notes = &quot;Unique identifier of the person. No two persons can have the same id.&quot;, example = &quot;1&quot;, required = true, position = 0)
    private int id;
    @ApiModelProperty(notes = &quot;First name of the person.&quot;, example = &quot;John&quot;, required = true, position = 1)
    private String firstName;
    @ApiModelProperty(notes = &quot;Last name of the person.&quot;, example = &quot;Doe&quot;, required = true, position = 2)
    private String lastName;
    @ApiModelProperty(notes = &quot;Age of the person. Non-negative integer&quot;, example = &quot;42&quot;, position = 3)
    private int age;

    // … Constructor, getters, setters, ...
&#125;</code></pre>
<p>支持JSR-303</p>
<p>  @NotNull    不为空<br>  @NotBlank   不为空 不为空字符串<br>  @Size(min = 1, max = 20)  字符串长度范围<br>  @Min(0)       最小值最大值设置<br>  @Max(100)<br>  @Pattern(regexp = “[SOME REGULAR EXPRESSION]”)   正则表达式设置  </p>
<p>做到上面几步就可以在api文档中看到效果了。类似如下：</p>
<p><img src="https://www.vojtechruzicka.com/static/57c53482f716c4648ec5d4c860c2a0e2/30398/swagger-ui.png"></p>
<p>或者采用不同的展示模板：</p>
<p><img src="https://static.oschina.net/uploads/space/2018/0716/075136_60JO_254762.png"></p>
<h2 id="Springfox原理"><a href="#Springfox原理" class="headerlink" title="Springfox原理"></a>Springfox原理</h2><p>Springfox生成Api文档的原理是，通过获取Spring上下文中<code>@Controller</code>以及<code>@RequestMapping</code>注解的Bean的信息，然后通过层层解析，最终按照Swagger的标准生成Api文档而得来的。</p>
<p>从RequestMappingHandlerMapping的一段源码上面看，就能够理解在<code>@Controller</code>和<code>@ResquestMapping</code>注解到一个Bean或其属性上之后，Spring做了什么，是如何用HandlerMapping将Http请求映射到响应的Bean的方法上的，以及是如何采用HandlerAdapter来处理Http请求的。</p>
<p>RequestMappingHandlerMapping中的两个关键方法：</p>
<pre><code>/**
 * &#123;@inheritDoc&#125;
 * Expects a handler to have a type-level @&#123;@link Controller&#125; annotation.
 */
@Override
protected boolean isHandler(Class&lt;?&gt; beanType) &#123;
    return (AnnotatedElementUtils.hasAnnotation(beanType, Controller.class) ||
            AnnotatedElementUtils.hasAnnotation(beanType, RequestMapping.class));
&#125;

private RequestMappingInfo createRequestMappingInfo(AnnotatedElement element) &#123;
    RequestMapping requestMapping = AnnotatedElementUtils.findMergedAnnotation(element, RequestMapping.class);
    RequestCondition&lt;?&gt; condition = (element instanceof Class ?
            getCustomTypeCondition((Class&lt;?&gt;) element) : getCustomMethodCondition((Method) element));
    return (requestMapping != null ? createRequestMappingInfo(requestMapping, condition) : null);
&#125;</code></pre>
<p>Springfox获取Controller Bean信息的类图：</p>
<p><img src="https://raw.githubusercontent.com/heqiao2010/heqiao2010.github.io/master/img/2019/swagger.png"></p>
<p>参考：<br><a target="_blank" rel="noopener" href="https://www.vojtechruzicka.com/documenting-spring-boot-rest-api-swagger-springfox/">https://www.vojtechruzicka.com/documenting-spring-boot-rest-api-swagger-springfox/</a></p>
<p><a target="_blank" rel="noopener" href="https://www.v2ex.com/t/493395">https://www.v2ex.com/t/493395</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2019/06/06/Swagger/" data-id="ckgkgph53000teywwcjkh9vfo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Api%E7%AE%A1%E7%90%86/" rel="tag">Api管理</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-记录一个MySql_count细节问题" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2019/01/01/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%AAMySql_count%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98/" class="article-date">
  <time datetime="2019-01-01T10:00:00.000Z" itemprop="datePublished">2019-01-01</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Mysql/">Mysql</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2019/01/01/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%AAMySql_count%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98/">记录一个MySql count细节问题</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://img.hacpai.com/bing/20180418.jpg?imageView2/1/w/960/h/520/interlace/1/q/100"></p>
<blockquote>
<p>下面两条SQL查询结果会不一样吗？</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">select count(1) from </span><br><span class="line">  (select distinct &#96;handler_name&#96;, &#96;retry_info&#96;, &#96;is_disabled&#96; from handler) as alia;</span><br><span class="line"></span><br><span class="line">select count(distinct &#96;handler_name&#96;, &#96;retry_info&#96;, &#96;is_disabled&#96;) from handler;</span><br></pre></td></tr></table></figure>

<h3 id="count-语法"><a href="#count-语法" class="headerlink" title="count()语法"></a>count()语法</h3><p>（1）count(*)—包括所有列，返回表中的记录数，相当于统计表的行数，在统计结果的时候，<strong>不会忽略列值为NULL的记录。</strong></p>
<p>（2）count(1)—忽略所有列，1表示一个固定值，也可以用count(2)、count(3)代替，在统计结果的时候，<strong>不会忽略列值为NULL的记录。</strong></p>
<p>（3）count(列名)—只包括列名指定列，返回指定列的记录数，在统计结果的时候，会忽略列值为NULL的记录（不包括空字符串和0），<strong>即列值为NULL的记录不统计在内。</strong></p>
<p>（4）count(distinct 列名)—只包括列名指定列，返回指定列的不同值的记录数，在统计结果的时候，在统计结果的时候，会忽略列值为NULL的记录（不包括空字符串和0），<strong>即列值为NULL的记录不统计在内。</strong></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>由于count（列名）时，为NULL时，不会统计在内，这个点，踩了个坑，这里记录一下，平时还是需要多注意下细节。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/wendychiang1991/article/details/70909958/">https://blog.csdn.net/wendychiang1991/article/details/70909958/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2019/01/01/%E8%AE%B0%E5%BD%95%E4%B8%80%E4%B8%AAMySql_count%E7%BB%86%E8%8A%82%E9%97%AE%E9%A2%98/" data-id="ckgkgph5u002neywwhfch0omk" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/MySql/" rel="tag">MySql</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-PropertyUtilsBean" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/25/PropertyUtilsBean/" class="article-date">
  <time datetime="2018-08-25T10:00:00.000Z" itemprop="datePublished">2018-08-25</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Spring/">Spring</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/25/PropertyUtilsBean/">PropertyUtilsBean</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://img.hacpai.com/bing/20181129.jpg?imageView2/1/w/960/h/520/interlace/1/q/100"> </p>
<h3 id="beanutils包"><a href="#beanutils包" class="headerlink" title="beanutils包"></a>beanutils包</h3><p>beanutils，顾名思义，是java bean的一个工具类，可以帮助我们方便的读取(get)和设置(set)bean属性值、动态定义和访问bean属性；<br>细心的话，会发现其实JDK已经提供了一个java.beans包，同样可以实现以上功能，只不过使用起来比较麻烦，所以诞生了apache commons beanutils；<br>看源码就知道，其实apache commons beanutils就是基于jdk的java.beans包实现的。</p>
<h3 id="AopCacheUtil"><a href="#AopCacheUtil" class="headerlink" title="AopCacheUtil"></a><a target="_blank" rel="noopener" href="https://github.com/heqiao2010/AopCacheUtil">AopCacheUtil</a></h3><p>之前在工作中，写了一个简单的自定义注解，后来自己凭印象写了个AopCacheUtil（还不完整），便于拦截DAO或者Controller层的方法调用，做缓存处理；当中就用到了PropertyUtilsBean，这个类。<br>在解析Bean属性的时候，挺方便的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.commons.beanutils.PropertyUtilsBean.getProperty(Object, String)</span><br></pre></td></tr></table></figure>

<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/chenpi/p/6917499.html">https://www.cnblogs.com/chenpi/p/6917499.html</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2018/08/25/PropertyUtilsBean/" data-id="ckgkgph4z000heyww6edgf3ro" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-如何从jar包中读取配置文件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/08/02/%E5%A6%82%E4%BD%95%E4%BB%8Ejar%E5%8C%85%E4%B8%AD%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" class="article-date">
  <time datetime="2018-08-02T10:00:00.000Z" itemprop="datePublished">2018-08-02</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF/">服务端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/08/02/%E5%A6%82%E4%BD%95%E4%BB%8Ejar%E5%8C%85%E4%B8%AD%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/">如何在jar包中读取配置文件 </a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://img.hacpai.com/bing/20180215.jpg?imageView2/1/w/960/h/520/interlace/1/q/100"></p>
<blockquote>
<p>今天开发的时候遇到一个问题——当程序以jar包运行的时候,有个txt配置文件无法获取到,但是本地测试无法复现.后来发现是因为以Jar包形式运行，文件无法访问到，这里记录一下。</p>
</blockquote>
<h3 id="1-如何判断当前进程是否以jar包形式运行的？"><a href="#1-如何判断当前进程是否以jar包形式运行的？" class="headerlink" title="1. 如何判断当前进程是否以jar包形式运行的？"></a>1. 如何判断当前进程是否以jar包形式运行的？</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * 是否以Jar包运行</span><br><span class="line"> * </span><br><span class="line"> * @return</span><br><span class="line"> *&#x2F;</span><br><span class="line">public static boolean isRunningInJar() &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        String className &#x3D; GenericUtils.class.getName().replace(&#39;.&#39;, &#39;&#x2F;&#39;);</span><br><span class="line">        String classJar &#x3D; GenericUtils.class.getResource(&quot;&#x2F;&quot; + className + &quot;.class&quot;).toString();</span><br><span class="line">        logger.info(&quot;classJar: &quot; + classJar);</span><br><span class="line">        return classJar.startsWith(&quot;jar:&quot;);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.warn(&quot;get Running status failed.&quot;);</span><br><span class="line">        return false;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-从Jar包中读取文件内容"><a href="#2-从Jar包中读取文件内容" class="headerlink" title="2.从Jar包中读取文件内容"></a>2.从Jar包中读取文件内容</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">public static String txt2String(String fileName) &#123;</span><br><span class="line">    StringBuilder result &#x3D; new StringBuilder();</span><br><span class="line">    BufferedReader br &#x3D; null;</span><br><span class="line">    try &#123;</span><br><span class="line">        Reader r &#x3D; null;</span><br><span class="line">        if (isRunningInJar()) &#123;</span><br><span class="line">            InputStream in &#x3D; GenericUtils.class.getResourceAsStream(File.separator + fileName);</span><br><span class="line">            r &#x3D; new InputStreamReader(in);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            String path &#x3D; GenericUtils.class.getClassLoader().getResource(fileName).getPath();</span><br><span class="line">            File file &#x3D; new File(path);</span><br><span class="line">            r &#x3D; new FileReader(file);</span><br><span class="line">        &#125;</span><br><span class="line">        br &#x3D; new BufferedReader(r);&#x2F;&#x2F; 构造一个BufferedReader类来读取文件</span><br><span class="line">        String s &#x3D; null;</span><br><span class="line">        while ((s &#x3D; br.readLine()) !&#x3D; null) &#123;&#x2F;&#x2F; 使用readLine方法，一次读一行</span><br><span class="line">            result.append(System.lineSeparator() + s);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        logger.error(&quot;error when function:getTxtFromFile!&quot;, e);</span><br><span class="line">    &#125; finally &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (br !&#x3D; null) &#123;</span><br><span class="line">                br.close();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (final IOException ioe) &#123;</span><br><span class="line">            &#x2F;&#x2F; ignore</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    return result.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2018/08/02/%E5%A6%82%E4%BD%95%E4%BB%8Ejar%E5%8C%85%E4%B8%AD%E8%AF%BB%E5%8F%96%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6/" data-id="ckgkgph5h0021eyww60t93yus" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-基于Ngxtop的QPS监控" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/07/14/%E5%9F%BA%E4%BA%8ENgxtop%E7%9A%84QPS%E7%9B%91%E6%8E%A7/" class="article-date">
  <time datetime="2018-07-14T10:00:00.000Z" itemprop="datePublished">2018-07-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/nginx/">nginx</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/07/14/%E5%9F%BA%E4%BA%8ENgxtop%E7%9A%84QPS%E7%9B%91%E6%8E%A7/">基于Ngxtop的QPS监控</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://img.hacpai.com/bing/20180309.jpg?imageView2/1/w/960/h/520/interlace/1/q/100"></p>
<blockquote>
<p>之前参与一个公有云项目的开发，系统入口是公有云平台提供的LB。云平台的LB再将请求转发到后方的多台Nginx，Nginx上再做反向代理到后方的服务器。为了获取系统的QPS，我们在Nginx服务器上写了个定时任务脚本，定期采集并发量，然后汇总。</p>
</blockquote>
<h3 id="并发量采集脚本"><a href="#并发量采集脚本" class="headerlink" title="并发量采集脚本"></a>并发量采集脚本</h3><ol>
<li>先安装ngxtop<br>依次运行：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo yum -y install epel-release</span><br><span class="line">sudo yum -y install python-pip #安装python-pip</span><br><span class="line">sudo yum clean all #清除缓存</span><br><span class="line">sudo pip install ngxtop #安装Ngxtop</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>注意：由于ngxtop是通过监控access.log文件来获取并发量的，因此nginx.conf中的access log一定要打开。</strong></p>
<p>安装好了之后就能得到当前这台nginx服务器上此时的并发量了。当然也可以通过一些参数对请求做一些过滤比如<code>ngxtop -i &#39;status &gt;= 400&#39; print request status http_referer</code>;我们获取的并发数是整个系统的，可以不过滤。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">running for 10 seconds, 1035 records processed: 102.47 req&#x2F;sec</span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line">|   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</span><br><span class="line">|---------+------------------+-------+-------+-------+-------|</span><br><span class="line">|    1035 |         4793.348 |   611 |   414 |    10 |     0 |</span><br><span class="line"></span><br><span class="line">Detailed:</span><br><span class="line">| request_path                                            |   count |   avg_bytes_sent |   2xx |   3xx |   4xx |   5xx |</span><br><span class="line">|---------------------------------------------------------+---------+------------------+-------+-------+-------+-------|</span><br><span class="line">| &#x2F;portal&#x2F;protocol                                        |     351 |            4.427 |    14 |   337 |     0 |     0 |</span><br><span class="line">| &#x2F;portal&#x2F;protocol&#x2F;onlines                                |	142 |           29.585 |   142 |     0 |     0 |     0 |</span><br><span class="line">| &#x2F;fs&#x2F;group1&#x2F;M00&#x2F;38&#x2F;1A&#x2F;wKgBjVr-enmAUwbrAAA4icErDmQ64.html |      93 |         7019.968 |    93 |     0 |     0 |     0 |</span><br><span class="line">| &#x2F;fs&#x2F;group1&#x2F;M00&#x2F;20&#x2F;55&#x2F;wKgBK1rX-yGAGUzxAAA2uqGptGw07.html |	 54 |         4009.000 |    54 |     0 |     0 |     0 |</span><br><span class="line">| &#x2F;portal&#x2F;getBindStatus                                   |	 48 |           92.000 |    48 |     0 |     0 |     0 |</span><br><span class="line">| &#x2F;portal&#x2F;portalError.jsp                                 |	 44 |         6481.818 |    44 |     0 |     0 |     0 |</span><br><span class="line">| &#x2F;fs&#x2F;group1&#x2F;M00&#x2F;3A&#x2F;C2&#x2F;wKgBjVsHZ2yADQyKAAA2BaQs3gQ79.html |	 42 |        12323.667 |    41 |     1 |     0 |     0 |</span><br><span class="line">| &#x2F;fs&#x2F;group1&#x2F;M00&#x2F;39&#x2F;D5&#x2F;wKgBjVsDzz-AEZ_BAAA3KhsbE4Q76.html |	 24 |         8877.833 |    23 |     1 |     0 |     0 |</span><br><span class="line">| &#x2F;fs&#x2F;group1&#x2F;M00&#x2F;3A&#x2F;C2&#x2F;wKgBjVsHZpKAcXlwAAA3pIzc9NQ54.html |	 14 |         4051.000 |    14 |     0 |     0 |     0 |</span><br><span class="line">| &#x2F;fs&#x2F;group1&#x2F;M00&#x2F;3A&#x2F;C2&#x2F;wKgBjVsHZ4mAemZDAAA2Ifroljg77.html |	 12 |         9739.083 |    12 |     0 |     0 |     0 |</span><br></pre></td></tr></table></figure>

<p>由于ngxtop命令，需要运行一段时间，才能计算出QPS值，因此我们不能获取这个命令的实时输出，而是需要延时后，取结果。通过如下的shell函数可以做到，延时输出。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">timeout() &#123;</span><br><span class="line"></span><br><span class="line">time&#x3D;$1</span><br><span class="line"></span><br><span class="line"># start the command in a subshell to avoid problem with pipes</span><br><span class="line"># (spawn accepts one command)</span><br><span class="line"></span><br><span class="line">command&#x3D;&quot;&#x2F;bin&#x2F;sh -c \&quot;$2\&quot;&quot;</span><br><span class="line"></span><br><span class="line">expect -c &quot;set echo \&quot;-noecho\&quot;; set timeout $time; spawn -noecho $command; expect timeout &#123; exit 1 &#125; eof &#123; exit 0 &#125;&quot;</span><br><span class="line"></span><br><span class="line">if [ $?  &#x3D; 1 ] ;  then</span><br><span class="line"></span><br><span class="line">echo  &quot;Timeout after $&#123;time&#125; seconds&quot;</span><br><span class="line"></span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">timeout 5s &#x2F;usr&#x2F;bin&#x2F;ngxtop &gt;  $work_dir&#x2F;out.txt   #运行ngxtop命令5s，然后将输出重定向到text文件中。</span><br></pre></td></tr></table></figure>
<p>剩下的工作就是将qps值从命令中截取出来即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">req_per_sec&#x3D;&#96;&#x2F;usr&#x2F;bin&#x2F;cat $work_dir&#x2F;out.txt|grep records |&#x2F;usr&#x2F;bin&#x2F;awk -F &#39;sec&#39; &#39;&#123;print $1&#125;&#39;|grep -oP -m 1 &quot;record.+&quot;|&#x2F;usr&#x2F;bin&#x2F;awk -F &#39;req&#39; &#39;&#123;print $1&#125;&#39;|&#x2F;usr&#x2F;bin&#x2F;awk -F&#39;:&#39; &#39;&#123;print $2&#125;&#39;&#96;</span><br></pre></td></tr></table></figure>


<h3 id="保证采集脚本在数台nginx服务器上并发执行"><a href="#保证采集脚本在数台nginx服务器上并发执行" class="headerlink" title="保证采集脚本在数台nginx服务器上并发执行"></a>保证采集脚本在数台nginx服务器上并发执行</h3><p>如何保证采集脚本在多台nginx上几乎同时执行呢——用<code>python-fab</code>实现。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"># -*- coding: utf-8 -*-</span><br><span class="line"># !&#x2F;usr&#x2F;bin&#x2F;python</span><br><span class="line"></span><br><span class="line">import os</span><br><span class="line">import paramiko</span><br><span class="line">import root_path</span><br><span class="line"></span><br><span class="line">from fabric.api import *</span><br><span class="line">from fabric.context_managers import settings</span><br><span class="line">from fabric.contrib.files import exists</span><br><span class="line">from fabric.decorators import hosts</span><br><span class="line"></span><br><span class="line">from utillib import CommonUtil</span><br><span class="line">from utillib import MySqlUtil</span><br><span class="line">from ngxtop import NgxtopDao</span><br><span class="line"></span><br><span class="line">paramiko.util.log_to_file(&quot;filename.log&quot;)</span><br><span class="line"></span><br><span class="line">logger &#x3D; CommonUtil.getLogger(__name__)</span><br><span class="line">env.user &#x3D; &#39;root&#39;</span><br><span class="line">env.key_filename &#x3D; &#39;&#x2F;root&#x2F;.ssh&#x2F;id_rsa.pub&#39;</span><br><span class="line">env.hosts&#x3D;CommonUtil.get_value_list(&#39;ngxtop&#39;) # 取nginx机器列表</span><br><span class="line"></span><br><span class="line">@task</span><br><span class="line">@parallel # 保证并发执行</span><br><span class="line">def collect_result():</span><br><span class="line">    if not exists(&#39;&#x2F;home&#x2F;azureuser&#x2F;auth-webserver&#x2F;ngxtop_statistics&#x2F;concurrent_statistics.sh&#39;):</span><br><span class="line">        run(&#39;mkdir -p &#x2F;home&#x2F;azureuser&#x2F;auth-webserver&#x2F;ngxtop_statistics&#39;)</span><br><span class="line">        put(&#39;&#x2F;home&#x2F;azureuser&#x2F;auth-webserver&#x2F;ngxtop&#x2F;concurrent_statistics.sh&#39;,&#39;&#x2F;home&#x2F;azureuser&#x2F;auth-webserver&#x2F;ngxtop_statistics&#39;) # 拷贝脚本</span><br><span class="line"></span><br><span class="line">    result&#x3D;run(&#39;sh &#x2F;home&#x2F;azureuser&#x2F;auth-webserver&#x2F;ngxtop_statistics&#x2F;concurrent_statistics.sh&#39;) # 执行脚本</span><br><span class="line">    #logger.info(result)</span><br><span class="line">    return result</span><br><span class="line"></span><br><span class="line">@task</span><br><span class="line">@hosts(CommonUtil.get_value_list(&#39;ngxtop&#39;))</span><br><span class="line">def delete_script():</span><br><span class="line">    run(&#39;rm -rf &#x2F;home&#x2F;azureuser&#x2F;auth-webserver&#x2F;ngxtop_statistics&#x2F;concurrent_statistics.sh&#39;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@task</span><br><span class="line">@runs_once # 入库保证只执行一次</span><br><span class="line">def save_to_database():</span><br><span class="line">    collected_output &#x3D; execute(collect_result)</span><br><span class="line">    create_time&#x3D;None</span><br><span class="line">    wrong_data_type&#x3D;False</span><br><span class="line">    create_time&#x3D;CommonUtil.get_local_time()</span><br><span class="line">    insert_table_name &#x3D; &#39;tbl_uam_ngxtop&#39;</span><br><span class="line">    for host, info in collected_output.iteritems():</span><br><span class="line">        logger.info(&quot;On host &#123;0&#125; last user was &#123;1&#125;&quot;.format(host, info))</span><br><span class="line">        data&#x3D;info.split(&#39; &#39;)</span><br><span class="line">        ngx_data&#x3D;&#123;&#125;</span><br><span class="line">        ngx_data[&#39;create_time&#39;] &#x3D; create_time</span><br><span class="line">        if(len(data) &#x3D;&#x3D; 2 ):</span><br><span class="line">            # 有些时候，取出的qps值中间可能会缺失一位，这里补5.</span><br><span class="line">            ngx_data[&#39;request_per_second&#39;] &#x3D; str(data[0]) + &#39;5&#39; + str(data[1])</span><br><span class="line">        else:</span><br><span class="line">            ngx_data[&#39;request_per_second&#39;] &#x3D; str(info)</span><br><span class="line">        ngx_data[&#39;ip&#39;] &#x3D; str(host)</span><br><span class="line">        NgxtopDao.save(insert_table_name,ngx_data)</span><br><span class="line">    logger.info(ngx_data)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if __name__ &#x3D;&#x3D; &#39;__main__&#39;:</span><br><span class="line">    os.system(&#39;fab -f NgxtopCollector.py save_to_database&#39;)</span><br></pre></td></tr></table></figure>
<p>那么这个python脚本，通过crontab每5min触发一次，就能得到相应的qps数据了。</p>
<h3 id="数据展示"><a href="#数据展示" class="headerlink" title="数据展示"></a>数据展示</h3><p>用E-charts做了个表格，这样几个系统的qps值就可以采集到了。其实通过这个可以做一个简单的告警，比如当qps值到达4000时，发送一个告警邮件，或者告警微信消息。<br><img src="https://raw.githubusercontent.com/heqiao2010/heqiao2010.github.io/master/img/qps.png" alt="qps" title="qps"></p>
<p><img src="https://raw.githubusercontent.com/heqiao2010/heqiao2010.github.io/master/img/qps2.png" alt="qps" title="qps"></p>
<p>感谢<a target="_blank" rel="noopener" href="http://yxs1112003.github.io/">YXS</a>编码实现。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2018/07/14/%E5%9F%BA%E4%BA%8ENgxtop%E7%9A%84QPS%E7%9B%91%E6%8E%A7/" data-id="ckgkgph5g001yeywwc7acflez" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E7%AB%AF/" rel="tag">服务端</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-步线程池优化" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/06/22/%E6%AD%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BC%98%E5%8C%96/" class="article-date">
  <time datetime="2018-06-22T10:00:00.000Z" itemprop="datePublished">2018-06-22</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF/">服务端</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/06/22/%E6%AD%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BC%98%E5%8C%96/">异步线程池优化</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://img.hacpai.com/bing/20180403.jpg?imageView2/1/w/960/h/520/interlace/1/q/100"></p>
<blockquote>
<p>目前在公司做的一个无线Wi-Fi认证系统，采用公有云模式，24小时不间断服务，而且在上班时间会有业务并发的高峰，目前高峰值能到4000多的qps，在这个领域来说，还是比较高的。在这种场景下需要将一些操作异步执行，以提高页面的响应速度，比如某些情况下将大对象入库，可以采用异步线程去处理，这样在入库没有完成时，请求就可以返回（前提是入库失败，不需要通知给客户端）。那么如何创建异步线程，去执行这种异步操作，在保证效率的同时，还不能被高并发冲垮呢？</p>
</blockquote>
<h2 id="异步操作的几种实现方式"><a href="#异步操作的几种实现方式" class="headerlink" title="异步操作的几种实现方式"></a>异步操作的几种实现方式</h2><h3 id="直接创建一个新线程"><a href="#直接创建一个新线程" class="headerlink" title="直接创建一个新线程"></a>直接创建一个新线程</h3><p>继承或者实现Runnable接口都可以创建一个异步子线程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">public class TestThread1 extends Thread&#123;  </span><br><span class="line">    private boolean flag &#x3D; true;  </span><br><span class="line">      </span><br><span class="line">    public static void main( String args[])  </span><br><span class="line">    &#123;  </span><br><span class="line">        TestThread1 t &#x3D; new TestThread1();  </span><br><span class="line">        t.start();  </span><br><span class="line">        for( int i&#x3D;0; i&lt;100; i++)  </span><br><span class="line">        &#123;  </span><br><span class="line">            try &#123;  </span><br><span class="line">                Thread.sleep(1000);  </span><br><span class="line">            &#125; catch (InterruptedException e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">            System.out.println(&quot;I&#39;m MainThread.&quot;);  </span><br><span class="line">        &#125;  </span><br><span class="line">        t.endSubThread();  </span><br><span class="line">        System.out.println(&quot;MainThread Stoped.&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    public void run()  </span><br><span class="line">    &#123;  </span><br><span class="line">        while( this.flag )  </span><br><span class="line">        &#123;  </span><br><span class="line">            try &#123;  </span><br><span class="line">                Thread.sleep(1000);  </span><br><span class="line">            &#125; catch (InterruptedException e) &#123;  </span><br><span class="line">                e.printStackTrace();  </span><br><span class="line">            &#125;  </span><br><span class="line">            System.out.println(&quot;----I&#39;m SubThread.&quot;);  </span><br><span class="line">        &#125;  </span><br><span class="line">        System.out.println(&quot;----SubThread Stoped.&quot;);  </span><br><span class="line">    &#125;  </span><br><span class="line">      </span><br><span class="line">    public void endSubThread()  </span><br><span class="line">    &#123;  </span><br><span class="line">        this.flag &#x3D; false;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>直接创建子线程可能会导致高并发请求时，创建线程耗费额外的时间，拖慢响应速度，也可能导致创建的线程数过多导致OOM，并且这种线程是一次性的，不能重用；这种方式，我们一开始就没有采用。</p>
<h3 id="采用固定大小的线程池"><a href="#采用固定大小的线程池" class="headerlink" title="采用固定大小的线程池"></a>采用固定大小的线程池</h3><p>线程池大小固定，避免请过多线程出现OOM的问题；而且线程可重用，以提升效率。如果并发数超过线程池大小，则任务会缓存到一个队列中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">package com.heqiao2010;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.ExecutorService;</span><br><span class="line">import java.util.concurrent.Executors;</span><br><span class="line">import java.util.concurrent.ThreadFactory;</span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * Created by h12111 on 2018&#x2F;6&#x2F;23.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class FixedThreadPool &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 当前线程池中线程数量</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private AtomicInteger currentThreadNum &#x3D; new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 线程池大小</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private static final Integer POOLSIZE &#x3D; 8;</span><br><span class="line"></span><br><span class="line">    private volatile ExecutorService executor &#x3D; null;</span><br><span class="line"></span><br><span class="line">    public FixedThreadPool()&#123;</span><br><span class="line">        this(POOLSIZE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public FixedThreadPool(Integer poolSize)&#123;</span><br><span class="line">        this.executor &#x3D; Executors.newFixedThreadPool(poolSize, new ThreadFactory()&#123;</span><br><span class="line">            @Override</span><br><span class="line">            public Thread newThread(Runnable r) &#123;</span><br><span class="line">                Thread thread &#x3D; new Thread(r);</span><br><span class="line">                thread.setName(&quot;FixedThreadPool&quot; + currentThreadNum.incrementAndGet());</span><br><span class="line">                thread.setDaemon(true);</span><br><span class="line">                System.out.println(currentThreadNum.get() + &quot; thread was created.&quot;);</span><br><span class="line">                return thread;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void execute(Runnable task)&#123;</span><br><span class="line">        this.executor.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">private static AtomicInteger sum &#x3D; new AtomicInteger(1000);</span><br><span class="line"></span><br><span class="line">public static void main(String args[])&#123;</span><br><span class="line">    FixedThreadPool threadPool &#x3D; new FixedThreadPool(100);</span><br><span class="line"> for(int i&#x3D;0; i&lt;111; i++)</span><br><span class="line">        threadPool.execute(() -&gt;&#123;</span><br><span class="line">            while(sum.get() &gt; 0)&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + &quot;: TestSum is &quot; + sum.get());</span><br><span class="line"> try&#123;</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">  &#125; catch (InterruptedException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">                sum.decrementAndGet();</span><br><span class="line">  &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">  &#x2F;&#x2F; 保证主线程不退出</span><br><span class="line">  while(sum.get() &gt; 0)&#123;</span><br><span class="line">        System.out.println(&quot;Not finish Yet!&quot;);</span><br><span class="line"> try&#123;</span><br><span class="line">            Thread.sleep(1000);</span><br><span class="line">  &#125; catch (InterruptedException e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">  &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>部分输出如下，当一次性提交111个任务时，只创建了100个线程。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">97 thread was created.</span><br><span class="line">FixedThreadPool96: TestSum is 1000</span><br><span class="line">98 thread was created.</span><br><span class="line">FixedThreadPool97: TestSum is 1000</span><br><span class="line">99 thread was created.</span><br><span class="line">FixedThreadPool98: TestSum is 1000</span><br><span class="line">100 thread was created.</span><br><span class="line">FixedThreadPool99: TestSum is 1000</span><br><span class="line">Not finish Yet!</span><br><span class="line">FixedThreadPool100: TestSum is 1000</span><br><span class="line">FixedThreadPool2: TestSum is 997</span><br></pre></td></tr></table></figure>

<h3 id="线程池优化——采用丢弃策略的线程池"><a href="#线程池优化——采用丢弃策略的线程池" class="headerlink" title="线程池优化——采用丢弃策略的线程池"></a>线程池优化——采用丢弃策略的线程池</h3><p>查看<code>Executors.newFixedThreadPool</code>的源码会发现，<code>ThreadPoolExecutor</code>的构造参数中传入了一个阻塞式任务队列，而这个队列居然是没有限制大小的。因此，当高并发时，过多的任务不会使系统创建过多的线程，但是都会堆积在队列中，这样同样可能会导致OOM。实际上，采用上面的实现方式，我们用Jmeter做压力测试的时候，就出现溢出了，服务挂了，且不能自愈，于是做了下面的优化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public static ExecutorService newFixedThreadPool(int nThreads, ThreadFactory threadFactory) &#123;</span><br><span class="line">    return new ThreadPoolExecutor(nThreads, nThreads,</span><br><span class="line">  0L, TimeUnit.MILLISECONDS,</span><br><span class="line"> new LinkedBlockingQueue(), &#x2F;&#x2F;这个队列的最大长度可以是：Integer.MAX_VALUE</span><br><span class="line">  threadFactory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>改进如下，对于在阻塞队列满了之后的任务，可以采取丢弃处理的策略，保证服务本身的安全。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line">package com.heqiao2010;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.*;</span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 一个可以丢弃任务的线程池</span><br><span class="line"> * Created by heqiao on 2018&#x2F;6&#x2F;22.</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class DiscardableThreadPool &#123;</span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 当前线程池中线程数量</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private AtomicInteger currentThreadNum &#x3D; new AtomicInteger(0);</span><br><span class="line"></span><br><span class="line">    private volatile ExecutorService executor &#x3D; null;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 任务丢弃策略&lt;&#x2F;&gt;</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public static class DiscardPolicy implements RejectedExecutionHandler&#123;</span><br><span class="line">        public DiscardPolicy()&#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 只是简单的打印了个日志</span><br><span class="line">         * @param r</span><br><span class="line">         * @param executor</span><br><span class="line">         *&#x2F;</span><br><span class="line">        @Override</span><br><span class="line">        public void rejectedExecution(Runnable r, ThreadPoolExecutor executor) &#123;</span><br><span class="line">            System.out.println(&quot;Task &quot; + r.toString() + &quot; rejected from &quot; + executor.toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static class Builder &#123;</span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 线程名前缀</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private String threadNamePrefix &#x3D; &quot;DiscardableThreadPool&quot;;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 线程池中最小线程数</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private Integer corePoolSize &#x3D; 16;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 最大线程数</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private Integer maximumPoolSize &#x3D; 128;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 线程超时回收时间</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private Long keepAliveTime &#x3D; 5L;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 线程超时回收时间单位</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private TimeUnit timeUnit &#x3D; TimeUnit.MINUTES;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 任务队列大小</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private Integer queueCapacity &#x3D; 500;</span><br><span class="line"></span><br><span class="line">        &#x2F;**</span><br><span class="line">         * 丢弃策略</span><br><span class="line">         *&#x2F;</span><br><span class="line">        private RejectedExecutionHandler handler &#x3D; new DiscardPolicy();</span><br><span class="line"></span><br><span class="line">        public Builder namePrefix(String prefix)&#123;</span><br><span class="line">            this.threadNamePrefix &#x3D; prefix;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder minPoolSize(int minPoolSize)&#123;</span><br><span class="line">            this.corePoolSize &#x3D; minPoolSize;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder maxPoolSize(int maxPoolSize)&#123;</span><br><span class="line">            this.maximumPoolSize &#x3D; maxPoolSize;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder keepAlive(long keepAliveTime, TimeUnit unit)&#123;</span><br><span class="line">            this.keepAliveTime &#x3D; keepAliveTime;</span><br><span class="line">            this.timeUnit &#x3D; unit;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder queueCapacity(int capacity)&#123;</span><br><span class="line">            this.queueCapacity &#x3D; capacity;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public Builder rejectedHanlder(RejectedExecutionHandler handler)&#123;</span><br><span class="line">            this.handler &#x3D; handler;</span><br><span class="line">            return this;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        public DiscardableThreadPool build()&#123;</span><br><span class="line">            return new DiscardableThreadPool(this);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 构造子</span><br><span class="line">     * @param builder</span><br><span class="line">     *&#x2F;</span><br><span class="line">    private DiscardableThreadPool(Builder builder)&#123;</span><br><span class="line">        if(null &#x3D;&#x3D; executor)&#123;</span><br><span class="line">            &#x2F;&#x2F; 线程工厂</span><br><span class="line">            ThreadFactory threadFactory &#x3D; new ThreadFactory() &#123;</span><br><span class="line">                @Override</span><br><span class="line">                public Thread newThread(Runnable r) &#123;</span><br><span class="line">                    Thread thread &#x3D; new Thread(r);</span><br><span class="line">                    thread.setName(builder.threadNamePrefix + currentThreadNum.incrementAndGet());</span><br><span class="line">                    thread.setDaemon(true);</span><br><span class="line">                    System.out.println(currentThreadNum.get() + &quot; thread was created.&quot;);</span><br><span class="line">                    return thread;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            &#x2F;&#x2F; 任务队列</span><br><span class="line">            BlockingQueue&lt;Runnable&gt; workQueue &#x3D; new LinkedBlockingDeque&lt;Runnable&gt;(builder.queueCapacity);</span><br><span class="line">            &#x2F;&#x2F; 初始化</span><br><span class="line">            executor &#x3D; new ThreadPoolExecutor(builder.corePoolSize, builder.maximumPoolSize, builder.keepAliveTime, builder.timeUnit,</span><br><span class="line">                    workQueue, threadFactory, builder.handler);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &#x2F;**</span><br><span class="line">     * 执行一个异步任务</span><br><span class="line">     * @param task</span><br><span class="line">     *&#x2F;</span><br><span class="line">    public void execute(Runnable task)&#123;</span><br><span class="line">        executor.submit(task);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;DiscardableThreadPool&#123;&quot; +</span><br><span class="line">                &quot;executor&#x3D;&quot; + executor +</span><br><span class="line">                &#39;&#125;&#39;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isShutDown()&#123;</span><br><span class="line">        return executor.isShutdown();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public boolean isTeminated()&#123;</span><br><span class="line">        return executor.isTerminated();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.heqiao2010;</span><br><span class="line"></span><br><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line">import java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line">&#x2F;**</span><br><span class="line"> * 测试！</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class Main &#123;</span><br><span class="line">    private static AtomicInteger sum &#x3D; new AtomicInteger(1000);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">         &#x2F;&#x2F;最多100个线程，队列大小是10个，理论上最大并发支持到110</span><br><span class="line">        DiscardableThreadPool threadPool &#x3D;</span><br><span class="line">                new DiscardableThreadPool.Builder().minPoolSize(8)</span><br><span class="line">                    .maxPoolSize(100).keepAlive(1, TimeUnit.MINUTES)</span><br><span class="line">                    .namePrefix(&quot;Test&quot;).queueCapacity(10)</span><br><span class="line">                        .build();</span><br><span class="line">          &#x2F;&#x2F;一次性提交111个任务</span><br><span class="line">        for(int i&#x3D;0; i&lt;111; i++)</span><br><span class="line">        threadPool.execute(() -&gt;&#123;</span><br><span class="line">            while(sum.get() &gt; 0)&#123;</span><br><span class="line">                System.out.println(Thread.currentThread().getName() + &quot;: TestSum is &quot; + sum.get());</span><br><span class="line">                try&#123;</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                &#125; catch (InterruptedException e)&#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                sum.decrementAndGet();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        &#x2F;&#x2F; 保证主线程不退出</span><br><span class="line">        while(sum.get() &gt; 0)&#123;</span><br><span class="line">            System.out.println(&quot;Not finish Yet!&quot;);</span><br><span class="line">            try&#123;</span><br><span class="line">                Thread.sleep(1000);</span><br><span class="line">            &#125; catch (InterruptedException e)&#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>部分输出如下，可见在线程池满了，而且队列也满了的情况下，任务就会被丢弃掉了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Test98: TestSum is 1000</span><br><span class="line">100 thread was created.</span><br><span class="line">Test99: TestSum is 1000</span><br><span class="line">Test77: TestSum is 1000</span><br><span class="line">Test68: TestSum is 1000</span><br><span class="line">Test72: TestSum is 1000</span><br><span class="line">Test76: TestSum is 1000</span><br><span class="line">Test80: TestSum is 1000</span><br><span class="line">Test84: TestSum is 1000</span><br><span class="line">Task java.util.concurrent.FutureTask@1e80bfe8 rejected from java.util.concurrent.ThreadPoolExecutor@66a29884[Running, pool size &#x3D; 100, active threads &#x3D; 100, queued tasks &#x3D; 10, completed tasks &#x3D; 0]</span><br><span class="line">Not finish Yet!</span><br><span class="line">Test92: TestSum is 1000</span><br><span class="line">Test88: TestSum is 1000</span><br><span class="line">Test81: TestSum is 1000</span><br><span class="line">Test100: TestSum is 1000</span><br></pre></td></tr></table></figure>


      
    </div>
    <footer class="article-footer">
      <a data-url="http://heqiao2010.github.io/2018/06/22/%E6%AD%A5%E7%BA%BF%E7%A8%8B%E6%B1%A0%E4%BC%98%E5%8C%96/" data-id="ckgkgph5s002jeyww3qwdfjmb" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/" rel="tag">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    
    <a class="extend prev" rel="prev" href="/">&amp;laquo; Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/">Next &amp;raquo;</a>
  </nav>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Arthas/">Arthas</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Freemarker/">Freemarker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java%E5%B9%B6%E5%8F%91%E5%9F%BA%E7%A1%80/">Java并发基础</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Mysql/">Mysql</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Spring/">Spring</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Swagger/">Swagger</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/git/">git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/github%E7%8E%A9%E5%AE%B6%E5%9F%BA%E6%9C%AC%E5%8A%9F/">github玩家基本功</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/logrotate/">logrotate</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/nginx/">nginx</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/syslog/">syslog</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9C%8D%E5%8A%A1%E7%AB%AF/">服务端</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%9D%82%E4%B8%83%E6%9D%82%E5%85%AB/">杂七杂八</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%99%9A%E6%8B%9F%E6%9C%BA/">虚拟机</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E9%9D%A2%E8%AF%95/">面试</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Api%E7%AE%A1%E7%90%86/" rel="tag">Api管理</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Arthas/" rel="tag">Arthas</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Freemarker/" rel="tag">Freemarker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/" rel="tag">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Maven/" rel="tag">Maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MySql/" rel="tag">MySql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Spring/" rel="tag">Spring</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VirtualBox/" rel="tag">VirtualBox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/" rel="tag">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E4%BB%A3%E7%A0%81%E7%BB%9F%E8%AE%A1/" rel="tag">代码统计</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9C%8D%E5%8A%A1%E7%AB%AF/" rel="tag">服务端</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E6%9D%82%E8%B0%88/" rel="tag">杂谈</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" rel="tag">面试题</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Api%E7%AE%A1%E7%90%86/" style="font-size: 10px;">Api管理</a> <a href="/tags/Arthas/" style="font-size: 10px;">Arthas</a> <a href="/tags/Freemarker/" style="font-size: 12.5px;">Freemarker</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Maven/" style="font-size: 10px;">Maven</a> <a href="/tags/MySql/" style="font-size: 10px;">MySql</a> <a href="/tags/Spring/" style="font-size: 15px;">Spring</a> <a href="/tags/VirtualBox/" style="font-size: 10px;">VirtualBox</a> <a href="/tags/git/" style="font-size: 10px;">git</a> <a href="/tags/linux/" style="font-size: 10px;">linux</a> <a href="/tags/%E4%BB%A3%E7%A0%81%E7%BB%9F%E8%AE%A1/" style="font-size: 10px;">代码统计</a> <a href="/tags/%E6%9C%8D%E5%8A%A1%E7%AB%AF/" style="font-size: 17.5px;">服务端</a> <a href="/tags/%E6%9D%82%E8%B0%88/" style="font-size: 10px;">杂谈</a> <a href="/tags/%E9%9D%A2%E8%AF%95%E9%A2%98/" style="font-size: 15px;">面试题</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/06/">June 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/07/">July 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/06/">June 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/02/">February 2018</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/06/30/Spring_Security%E5%A6%82%E4%BD%95%E4%BC%98%E9%9B%85%E7%9A%84%E8%BF%87%E6%BB%A4%E6%8E%89%E9%9D%99%E6%80%81%E9%A1%B5%E9%9D%A2%E8%AF%B7%E6%B1%82/">Spring Security 如何优雅的过滤掉静态页面请求</a>
          </li>
        
          <li>
            <a href="/2020/06/17/%E5%BF%97%E5%BD%92%E6%A1%A3%E5%B7%A5%E5%85%B7logrotate%E4%BB%8B%E7%BB%8D/">日志归档工具logrotate介绍</a>
          </li>
        
          <li>
            <a href="/2019/07/26/Freemarker%E4%B8%AD%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8CJson%E8%BD%AC%E5%8C%96/">Freemarker中如何进行Json转化</a>
          </li>
        
          <li>
            <a href="/2019/07/08/ControllerAdvice%E6%B3%A8%E8%A7%A3/">ControllerAdvice注解</a>
          </li>
        
          <li>
            <a href="/2019/07/02/Spring%E5%AD%A6%E4%B9%A0%E4%B9%8BProfile%E5%92%8CLookup%E6%B3%A8%E8%A7%A3/">Spring学习之Profile和Lookup注解</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 heqiao2010<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>